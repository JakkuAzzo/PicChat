<!-- templates/chat.html -->
{% extends 'base.html' %}
{% block title %}PicChat - Chat{% endblock %}
{% block content %}
<div class="app-container">
    <!-- Left Sidebar -->
    <div class="sidebar-left" id="sidebar-left">
        <div class="header">
            <button class="collapse-button" onclick="toggleSidebar('left')">&#9776;</button>
            <h3>Conversations</h3>
            <button class="plus-button" onclick="toggleSearch()">+</button>
            <div id="search-container" style="display: none;">
                <input type="text" id="search-input" placeholder="Enter username..." autocomplete="off" oninput="searchUsers()">
                <div id="search-results"></div>
            </div>
        </div>
        <ul class="conversations-list">
            {% if conversations %}
                {% for convo in conversations %}
                    <li>
                        <a href="javascript:void(0);" onclick="loadConversation({{ convo['id'] }})">{{ convo['contact_username'] }}</a>
                        <span class="last-message-time">{{ convo['last_message_time'] }}</span>
                        <div class="conversation-options">
                            <a href="{{ url_for('download_conversation', conversation_id=convo['id']) }}">Download</a>
                            <form action="{{ url_for('delete_conversation', conversation_id=convo['id']) }}" method="post" style="display:inline;">
                                <button type="submit">Delete</button>
                            </form>
                            <a href="{{ url_for('chat_settings', conversation_id=convo['id']) }}">Settings</a>
                        </div>
                    </li>
                {% endfor %}
            {% else %}
                <p>No conversations yet. Use '+' to start a new one.</p>
            {% endif %}
        </ul>
    </div>
    
    <!-- Main Chat Area -->
    <div class="main-chat" id="main-chat">
        <p>Select a conversation to start chatting.</p>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    function toggleSidebar(side) {
        const leftSidebar = document.getElementById('sidebar-left');
        if (side === 'left') {
            leftSidebar.classList.toggle('collapsed');
        }
    }

    function toggleSearch() {
        const searchContainer = document.getElementById('search-container');
        searchContainer.style.display = searchContainer.style.display === 'none' ? 'block' : 'none';
    }

    function searchUsers() {
        const query = document.getElementById('search-input').value;
        if (query.length > 1) {
            fetch('{{ url_for("search_users") }}', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ search_query: query })
            }).then(response => response.json()).then(data => {
                const results = document.getElementById('search-results');
                results.innerHTML = '';
                data.usernames.forEach(username => {
                    const div = document.createElement('div');
                    div.textContent = username;
                    div.onclick = () => startConversation(username);
                    results.appendChild(div);
                });
            });
        }
    }

    function startConversation(username) {
        fetch('{{ url_for("start_conversation") }}', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ contact: username })
        }).then(response => {
            if (response.ok) {
                window.location.reload();
            } else {
                alert('Failed to start conversation.');
            }
        });
    }

    function loadConversation(conversationId) {
    $.ajax({
        url: "{{ url_for('chat') }}",
        type: "GET",
        data: { conversation_id: conversationId },
        success: function(response) {
            console.log(response); // Log the response to check its content
            $('#main-chat').html(response);
            document.querySelector('.chat-input').style.display = 'block';
        },
        error: function() {
            alert('Failed to load conversation.');
        }
    });
}

    $(document).ready(function() {
        $('#message-form').on('submit', function(event) {
            event.preventDefault(); // Prevent default form submission
            $.ajax({
                url: $(this).attr('action'),
                type: $(this).attr('method'),
                data: $(this).serialize(),
                success: function(response) {
                    loadConversation($('input[name="conversation_id"]').val()); // Reload the conversation
                    $('#message-form')[0].reset(); // Reset the form
                },
                error: function() {
                    alert('Failed to send message.');
                }
            });
        });
    });
</script>
{% endblock %}
